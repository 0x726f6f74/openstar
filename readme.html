<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="tags" content="OpenResty,OpenStar,waf+,云waf,nginx lua">
<meta name="grammar_cjkruby" content="true"><style>body {
  max-width: 980px;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 45px;
}

@font-face {
  font-family: fontawesome-mini;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before,
.markdown-body hr:after {
  display: table;
  content: " ";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -moz-linear-gradient(#fefefe, #e7e7e7);
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headeranchor-link {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .headeranchor-link:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .headeranchor,
.markdown-body h2 .headeranchor,
.markdown-body h3 .headeranchor,
.markdown-body h4 .headeranchor,
.markdown-body h5 .headeranchor,
.markdown-body h6 .headeranchor {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .headeranchor-link,
.markdown-body h2:hover .headeranchor-link,
.markdown-body h3:hover .headeranchor-link,
.markdown-body h4:hover .headeranchor-link,
.markdown-body h5:hover .headeranchor-link,
.markdown-body h6:hover .headeranchor-link {
  height: 1em;
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .headeranchor-link .headeranchor,
.markdown-body h2:hover .headeranchor-link .headeranchor,
.markdown-body h3:hover .headeranchor-link .headeranchor,
.markdown-body h4:hover .headeranchor-link .headeranchor,
.markdown-body h5:hover .headeranchor-link .headeranchor,
.markdown-body h6:hover .headeranchor-link .headeranchor {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .codehilite pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition {
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  position: relative;
  border-radius: 3px;
  border: 1px solid #e0e0e0;
  border-left: 6px solid #333;
  padding: 10px 10px 10px 30px;
}

.markdown-body .admonition table {
  color: #333;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition-title {
  font-weight: bold;
  margin: 0;
}

.markdown-body .admonition>.admonition-title {
  color: #333;
}

.markdown-body .attention>.admonition-title {
  color: #a6d796;
}

.markdown-body .caution>.admonition-title {
  color: #d7a796;
}

.markdown-body .hint>.admonition-title {
  color: #96c6d7;
}

.markdown-body .danger>.admonition-title {
  color: #c25f77;
}

.markdown-body .question>.admonition-title {
  color: #96a6d7;
}

.markdown-body .note>.admonition-title {
  color: #d7c896;
}

.markdown-body .admonition:before,
.markdown-body .attention:before,
.markdown-body .caution:before,
.markdown-body .hint:before,
.markdown-body .danger:before,
.markdown-body .question:before,
.markdown-body .note:before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: #333;
  position: absolute;
  left: 0;
  top: 0;
  padding-top: 10px;
  padding-left: 10px;
}

.markdown-body .admonition:before {
  content: "\f056\00a0";
  color: 333;
}

.markdown-body .attention:before {
  content: "\f058\00a0";
  color: #a6d796;
}

.markdown-body .caution:before {
  content: "\f06a\00a0";
  color: #d7a796;
}

.markdown-body .hint:before {
  content: "\f05a\00a0";
  color: #96c6d7;
}

.markdown-body .danger:before {
  content: "\f057\00a0";
  color: #c25f77;
}

.markdown-body .question:before {
  content: "\f059\00a0";
  color: #96a6d7;
}

.markdown-body .note:before {
  content: "\f040\00a0";
  color: #d7c896;
}

.markdown-body .admonition::after {
  content: normal;
}

.markdown-body .attention {
  border-left: 6px solid #a6d796;
}

.markdown-body .caution {
  border-left: 6px solid #d7a796;
}

.markdown-body .hint {
  border-left: 6px solid #96c6d7;
}

.markdown-body .danger {
  border-left: 6px solid #c25f77;
}

.markdown-body .question {
  border-left: 6px solid #96a6d7;
}

.markdown-body .note {
  border-left: 6px solid #d7c896;
}

.markdown-body .admonition>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #ededed;
  position: relative;
  box-shadow: inset -1px 1px 3px rgba(0, 0, 0, .1);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: #333;
  text-shadow: 1px 1px 0 #fefefe, -1px -1px 0 #fefefe, -1px 1px 0 #fefefe, 1px -1px 0 #fefefe, 0 1px 0 #fefefe, 0 -1px 0 #fefefe, 1px 0 0 #fefefe, -1px 0 0 #fefefe, 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* Multimarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: #c82829;
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: #718c00 ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: #8e908c;
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.headeranchor:before {
  content: '\f05c';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body a,
  .markdown-body a:visited {
    text-decoration: underline;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]:after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a:after,
  .markdown-body a[href^="javascript:"]:after,
  .markdown-body a[href^="#"]:after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><title>OpenStar(开心)说明</title></head><body><article class="markdown-body"><hr />
<p>欢迎使用 <strong>{OpenStar}(WAF+)</strong>，该项目是从实际需求中产生，经过多次的版本迭代，实属不易。感谢<strong>春哥</strong>，以及<a href="https://github.com/agentzh">春哥</a>的神器（<strong><a href="http://openresty.org/cn/">OpenResty</a></strong>）<br />
注意：使用版本一定要大于 1.11.0 因为使用了ngx.var.request_id<br />
<strong>代码写的比较好理解，肯定不优雅  哈~</strong></p>
<p><strong>开源软件离不开大家的支持，如果公司用的可以，不妨购买技术支持服务吧【2000/月; 支付宝、微信：18801180400（留言注明公司等联系方式）。谢谢支持</strong></p>
<p>正在更新说明WIKI篇,已经更新了安装篇，请自行查阅。</p>
<p><a href="https://github.com/starjun/openstar/wiki/%E5%AE%89%E8%A3%85%E7%AF%87">安装篇</a><br />
<a href="https://github.com/starjun/openstar/wiki/base.json%E9%85%8D%E7%BD%AE">基础配置说明</a> base.json<br />
<a href="#step0">STEP 0：realIpFrom_Mod</a><br />
<a href="#step1">STEP 1：ip_Mod</a><br />
<a href="#step2">STEP 2：host_method_Mod</a><br />
<a href="#step3">STEP 3：rewrite_Mod</a><br />
<a href="#step4">STEP 4：host_Mod</a><br />
<a href="#step5">STEP 5：app_Mod</a><br />
<a href="#step6">STEP 6：referer_Mod</a><br />
<a href="#step7">STEP 7：uri_Mod</a><br />
<a href="#step8">STEP 8：header_Mod</a><br />
<a href="#step9">STEP 9：useragent_Mod</a><br />
<a href="#step10">STEP 10：cookie_Mod</a><br />
<a href="#step11">STEP 11：args_Mod</a><br />
<a href="#step12">STEP 12：post_Mod</a><br />
<a href="#step13">STEP 13：network_Mod</a><br />
<a href="#step14">STEP 14：replace_Mod</a></p>
<p>一些同学问的比较多的问题：</p>
<p>0：规则组问题<br />
支持IFTTT模式，如条件是（referer中包含baidu 或者 cookie中不包含abc 且useragent正则匹配spider）等等这样复杂的表达式，执行动作也是有多个可以使用(deny allow log refile rehtml relua*)可以定制各种复杂的场景。</p>
<p>1：关于多站点的事</p>
<p>使用ngx本身的增加配置文件就不说了，使用动态upstream可以参考我另外的项目https://github.com/starjun/dynamic_upstream-by-balancer<br />
一些接口没有加上去，看看代码自己非常容易搞定了。反向代理的host和后端的IP组都在DICT中（注意是IP组，而不仅仅是类似一些balancer写动态upstream的是一个IP），且支持多种负载均衡方式，相信可以满足大多数需求。https的后面有时间我在完善下。</p>
<p>2：集群相关(提供了Master/Slave配置)</p>
<p>目前openstar是支持集群的，规则同步和下发等都是提供了api，都是被动方式，规则为什么没有放到redis中，请自己测试一下，每次规则过滤都从redis取后在序列化，和从dict取在序列化，自己动手测试看性能，顺便说下，规则在集群下当然存在redis中，都是通过api进行操作更新到dict中，而不是每次都从redis中取，且最近增加了定时从redis拉取配置功能（测试中&hellip;）</p>
<p>3：如有一些技术类问题，请尽量完整一些，包括ngx配置文件，和比较完整的代码，不然真心不好作答，有时间我会尽量回复（不一定是对的），没时间回复的请谅解。</p>
<p>admin@17173.com邮箱已经没有在用了，请不要给这个发邮箱啦，<a href="mailto:18801180400@qq.com">18801180400@qq.com</a>，也是手机、微信。</p>
<h2 id="todo"><a name="user-content-todo" href="#todo" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>TODO</h2>
<p>无</p>
<p>商业版说明：<br />
<strong>支持域名管理，支持geoip（按国家，城市进行拦截等），支持SQL语义分析，更强大的api接口，默认规则更强大等等</strong></p>
<hr />
<p>CC防护、防抓取、刷单等防护算法：</p>
<p>CC攻击点：</p>
<p>a：用户可直接访问的url(搜索请求[数据库查询]，高计算[cpu计算]，随机url[耗连接]等)</p>
<p>b：嵌入类型的url(嵌入的验证码url[CPU计算]、ajax判断用户是否存在的url[数据库查询]等)</p>
<p>c：非浏览器类型的接口(一些公共API、WEBservice等无SDK的接口)</p>
<p>d：特定语言、服务器的攻击(php dos、慢速攻击等)</p>
<p>我提供的防护算法是用于防护a、b类型的攻击，a类型防护启用时，可以先生成一个添加标记的跳转页面，b类型防护启用时，动态对其渲染页面进行标记的添加，c类型有sdk，自己写代码支持自己设定的防护算法的不是问题。</p>
<p>js静态、动态验证：</p>
<p>跳转页面/渲染页面对下一次请求的url进行标记增加（openstar已经实现的增加url尾巴），增加一个get的args参数，参数名称和值都是由服务器产生或者前端页面js产生，如对下一次请求的url增加<code>cc=1ldldj</code>这个尾巴，服务端判断合法性有静态的正则判断值的合法性，有动态的判断值是否由服务器生成的,合法性检查更加严格。</p>
<p>js增强：（获取鼠标轨迹、鼠标点击事件、随机延迟、基于特定浏览器对js的方言）</p>
<p>普通的js一些攻击软件或者爬虫工具是可以分析执行的，故可以进行js增加，如判断鼠标轨迹、鼠标点击事件这些事件判断失败就不会进行下一步请求；如基于浏览器的js方言，一些浏览器会有自己的方言，那些爬虫工具和攻击工具是不可能解析js方言的，就不会进行下一步请求；还有使用js随机延迟函数，用于下一次请求的时间分流，这样请求频率就会被分开，这样就缓解了请求频率，以及结合鼠标轨迹和鼠标事件判断，可以很好的识别工具和人。</p>
<p>浏览器指纹：（对浏览器会生成一个唯一指纹，从而判断链式请求指纹的一致性）<br />
广告厂商来做这件事就事半功倍了，毕竟浏览器指纹在整个互联网的数据还是很有参考价值的，毕竟不是要指纹对应的广告标签等这些商业价值数据，仅是需要一个指纹的信誉库（同IP信誉库类似，当然也有时效性），因为CC攻击和一些爬虫、刷单工具在互联网上的指纹还是非常清晰的。<br />
情况可以公司可以建立自己的体系，对CC攻击、页面抓取、刷单是有相当大的帮助的，以后各大公司可以共享这些浏览器指纹数据，组成一个联盟也行，从而判断该指纹是否是真实用户等一些可用数据。</p>
<p><a href="http://123.57.220.116/fgjs2.html">http://123.57.220.116/fgjs2.html</a> 看看自己的浏览器指纹吧(如果访问不了，哈，我买的ECS过期了！)</p>
<p>参考：<a href="https://github.com/Valve/fingerprintjs2">https://github.com/Valve/fingerprintjs2</a></p>
<p>控件/浏览器防护:</p>
<p>使用js进行下一次请求的跳转，以及增强的鼠标轨迹、鼠标事件、浏览器js方言等这些判断还是有一定的缺陷，故可以直接使用控件方式、或者和浏览器合作（浏览器支持这种防护标记）</p>
<pre><code>PS：简单举个例子
http://www.cc.com?cc=@{&quot;api&quot;:&quot;http://1.1.1.1/cc/api&quot;,&quot;key&quot;:&quot;iodjdjkdldskl&quot;}@
http://www.cc.com?cc=@{&quot;api&quot;:&quot;tcp://1.1.1.1:908&quot;,&quot;key&quot;:&quot;iodjdjkdldskl&quot;}@
http://www.cc.com?cc=@{&quot;api&quot;:&quot;local&quot;,&quot;key&quot;:&quot;1:2345:44&quot;}@
跳转页面或者渲染页面，控件/浏览器是可以识别@中间的内容的，向这个api使用key取到一个值，下一次请求带上这个值。

</code></pre>

<p>i：set 一个cookie,其合法性是由控件和web服务器双向约定或加密产生，从而判断下一次请求是否合法</p>
<p>ii：增加args参数尾巴，其value值合法性由控件和web服务器双向约定或加密产生，从而判断下一次请求是否合法</p>
<p>iii：增加POST参数，其value值合法性由控件和web服务器双向约定或加密产生，等等对下一次请求进行验证增加</p>
<h2 id="_1"><a name="user-content-_1" href="#_1" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>重点</h2>
<p>这些防护算法我正在申请相关专利，个人用户以后永久免费的，仅对企业收费，请抄袭党，无耻公司放过小弟一码。</p>
<p>这些防护算法我正在申请相关专利，个人用户以后永久免费的，仅对企业收费，请抄袭党，无耻公司放过小弟一码。</p>
<p>这些防护算法我正在申请相关专利，个人用户以后永久免费的，仅对企业收费，请抄袭党，无耻公司放过小弟一码。</p>
<h1 id="_2"><a name="user-content-_2" href="#_2" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>概览</h1>
<hr />
<p><strong>OpenStar</strong>是一个基于<a href="http://openresty.org/cn/">OpenResty</a>的，高性能WAF，还相应增加了其他灵活、友好、实用的功能，是增强的WAF。<br />
<strong>app_Mod 支持规则组 连接符支持 or , 参考doc/demo.md文档</strong></p>
<h1 id="waf"><a name="user-content-waf" href="#waf" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>WAF防护</h1>
<hr />
<p>在<strong>OpenStar</strong>中的WAF防护模块，采用传统的字符串的匹配如正则过滤、包含等（<em>有人会问现在不是流行自主学习么；正则、包含等会有盲点、会被绕过；WAF的误报和漏报问题等等......</em>）。<strong>规则不是万能的，但是没有规则是万万不能的</strong> 这里我简单说明一下，自主分析学习引擎是我们的日志分析引擎做的（预留了api可实时增加拦截），这里是高性能、高并发的点，就用简单快速的方法解决，且根据业务实际调整好防护策略，可以解决绝大多数WEB安全1.0和WEB安全2.0类型的漏洞（90%+的问题）。<br />
WAF 防护从header,args,post,访问频率等，分层进行按顺序防护，详细在后面的功能会详细说明</p>
<ul>
<li>
<p><strong>WEB安全1.0</strong><br />
   在1.0时代下，攻击是通过服务器漏洞（IIS6溢出等）、WEB应用漏洞（SQL注入、文件上传、命令执行、文件包含等）属于服务器类的攻击，该类型漏洞虽然经历了这么多年，很遗憾，此类漏洞还是存在，并且重复在犯相同的错误。</p>
</li>
<li>
<p><strong>WEB安全2.0</strong><br />
   随着社交网络的兴起，原来不被重视的XSS、CSRF等漏洞逐渐进入人们的视野，那么在2.0时代，漏洞利用的思想将更重要，发挥你的想象，可以有太多可能。</p>
</li>
<li>
<p><strong>WEB安全3.0</strong><br />
   同开发设计模式类似（界面、业务逻辑、数据），3.0将关注应用本身的业务逻辑和数据安全，如密码修改绕过、二级密码绕过、支付类漏洞、刷钱等类型的漏洞，故注重的是产品本身的业务安全、数据安全、风控安全等。</p>
</li>
</ul>
<blockquote>
<p><code>安全不仅仅是在技术层面、还应该在行政管理层面、物理层面去做好安全的防护，才能提供最大限度的保护。</code><br />
安全行业多年的从业经验：人，才是最大的威胁；无论是外部、内部、无心、有意过失。（没有丑女人、只有懒女人）我想可以套用在此处，纯属个人见解。</p>
</blockquote>
<h1 id="cc"><a name="user-content-cc" href="#cc" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>CC/采集防护</h1>
<p>什么是<strong>CC攻击</strong>，简单的说一下，就是用较少的代价恶意请求web（应用）中的重资源消耗点（CPU/IO/数据库等等）从而达到拒绝服务的目的；<strong>数据采集</strong>，就是内容抓取了，简单这么理解吧</p>
<blockquote>
<p><code>非官方学术类的解释，先将就理解下</code><br />
<strong>关于本文对CC攻击的分析和相关的防护算法，都是我在实战中分析总结，并形成自己的方法论，不足之处、欢迎指正。</strong></p>
</blockquote>
<h2 id="_3"><a name="user-content-_3" href="#_3" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>攻击类型</h2>
<ul>
<li>行为（GET、POST等）<br />
  目前主要还是这两中method攻击为主，其他的少之又少。</li>
<li>
<p>被攻击的点</p>
<p>1：用户可直接访问的URL（搜索、重CPU计算、IO、数据库操作等）</p>
<p>2：嵌入的URL（验证码、ajax接口等）</p>
<p>3：面向非浏览器的接口（一些API、WEBservice等）</p>
<p>4：基于特定web服务、语言等的特定攻击（慢速攻击、PHP-dos等） </p>
</li>
</ul>
<blockquote>
<p><code>面对CC攻击我们需要根据实际情况采用不同的防护算法，比如攻击的点是一个ajax点，你使用js跳转/验证码肯定就有问题</code></p>
</blockquote>
<h2 id="_4"><a name="user-content-_4" href="#_4" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>防护方法</h2>
<ul>
<li>
<p>网络层<br />
 通过访问ip的频率、统计等使用阀值的方式进行频率和次数的限制，黑名单方式</p>
</li>
<li>
<p>网络层+应用层<br />
 在后来的互联网网络下，有了的CDN加入，现在增加的网络层的防护需要扩展，那么统计的IP将是在HTTP头中的IP，仍然使用频率、次数、黑名单的方式操作。 </p>
<blockquote>
<p><code>但是很多厂家的硬件流量清洗等设备，有的获取用户真实IP从HTTP头中取的是固定字段（X-FOR-F），不能自定义，更甚至有的厂家就没有该功能，这里就不说具体的这些厂家名字了</code>PS: 在传统的4层防护上，是没有问题的</p>
</blockquote>
</li>
<li>
<p>应用层 <br />
TAG验证、SET COOKIE、URL跳转、JS跳转、验证码、页面嵌套、强制静态缓存等<br />
防护是需要根据攻击点进行分别防护的，如攻击的是嵌入的url，我们就不能使用JS跳转、302验证码等这样的方法；<strong>在多次的CC防护实战中，如使用url跳转、set cookie，在新型的CC攻击下，这些防护都已经失效了</strong>。后面我会分享一下我的防护算法，并且在<strong>OpenStar</strong>中已经可以根据情况实现我所说的防护算法。<br />
浏览器是可以执行JS和flash的，这里我分享一些基于JS的防护算法，flash需要自己去写（比js复杂一些），可以实现flash应用层的安全防护和防页面抓取（开动你的大脑吧）</p>
</li>
</ul>
<p>1：客户端防护<br />
使用JS进行前端的防护（浏览器识别、鼠标轨迹判断、url有规则添加尾巴（args参数）、随机延迟、鼠标键盘事件获取等）其实这里非常复杂，如浏览器的识别 ie 支持 <code>!-[1,]</code> 这个特殊JS，一些JS方言，一些浏览器有自定义标签等等；</p>
<p>2：服务端防护<br />
url添加的尾巴（args参数）是服务器动态生成的token，而不是使用静态的正则去匹配其合法性。</p>
<p>3：特定攻击<br />
该类特定攻击，可以通过特征快速匹配出来（慢速攻击、PHP5.3的http头攻击）</p>
<p><strong>简单场景</strong></p>
<p>1：用户可直接访问的url（这种是最好防的）</p>
<p>第一阶段：</p>
<ul>
<li>
<p>网络层：访问频率限制，超出阀值仅黑名单一段时间</p>
</li>
<li>
<p>应用层：js跳转、验证码、flash策略（拖动识别等）</p>
</li>
</ul>
<p>2：嵌入的url（ajax校验点、图片验证码）</p>
<p>第一阶段：</p>
<ul>
<li>
<p>网络层：访问频率限制，超出阀值仅黑名单一段时间</p>
</li>
<li>
<p>应用层：载入被攻击的url页面，重写页面，使用js方操作链接被攻击的url。js随机在url尾巴增加有一定规则的校验串，服务端对串进行静态正则校验。</p>
</li>
</ul>
<p>第二阶段：</p>
<ul>
<li>
<p>网络层+应用层：用户ip在http头中，需要从http头取ip，在进行频率限制<br />
（其实做好了，这一层的防护，基本不用进入第三阶段的应用层防护了）</p>
</li>
<li>
<p>应用层：校验串使用服务端生成的token，进行严格服务器token验证检查</p>
</li>
</ul>
<p>第三阶段：</p>
<ul>
<li>应用层：js增加浏览器识别（不同agent匹配不同JS方言代码）、JS随机延迟、鼠标轨迹验证、键盘鼠标事件验证等js增加验证后，在进行校验串生成。</li>
</ul>
<p>说明：多次实战CC处理经验，很少到第三阶段，当然储备好这些JS脚本非常重要，纯JS肯定也是有限的，所有我就提出了使用控件，甚至是和浏览器厂商合作等更精准的防护方法。这样对CC攻击、页面抓取、刷单等有非常好的防护效果。</p>
<blockquote>
<p>应用层的防护是在网络层+扩展的网络层防护效果不佳时使用，一般情况基本用的不多，因为在OpenStar的防护下，极少数情况下，需要第三阶段防护。在防页面抓取时，发挥你的想象（js是个好帮手，善用）使用OpenStar就可以帮你快速实现；当然使用flash防抓取效果更好（不够灵活）。</p>
</blockquote>
<h1 id="_5"><a name="user-content-_5" href="#_5" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>目录</h1>
<p>后续更新！~</p>
<h1 id="_6"><a name="user-content-_6" href="#_6" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>下载</h1>
<p>wget</p>
<p>git clone </p>
<p><strong>已经打包的一些脚本，请参考bash目录</strong></p>
<h1 id="_7"><a name="user-content-_7" href="#_7" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>安装</h1>
<ul>
<li>安装OpenResty<br />
 这里不做过多重复描述，直接看链接<a href="http://openresty.org/cn/">OpenResty</a></li>
<li>配置nginx.conf<br />
 在http节点，引用waf.conf。注：原ngx相关配置基本不用修改，该优化优化、该做CPU亲缘绑定继续、该动静分离还继续、该IO、TIME等优化继续不要停。</li>
<li>配置waf.conf<br />
 修改lua_package_path，使用正确的路径即可；修改那些lua文件的路径，多检查几遍。</li>
<li>设置目录权限<br />
 OpenStar目录建议放到OR下，方便操作，该目录ngx运行用户有读写执行权限即可。因为要写日志，<em>暂时没有用ngx.log，后续可能会改动</em>。</li>
<li>lua文件修改<br />
 在init.lua中，修改conf_json参数，base.json文件绝对路径根据自己的情况写正确。</li>
<li>api使用<br />
2016年6月7日 23:31:09 更新啦，引用waf.conf，后就可以直接使用api接口了，通过监听5460端口来给管理用啦，界面也在筹划中，期待有人可以加入，帮我一起整界面。</li>
</ul>
<p><strong>已经打包的一些脚本，请参考bash目录，运行前请阅读一下，感谢好友余总帮助写的脚本</strong></p>
<h1 id="_8"><a name="user-content-_8" href="#_8" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>使用</h1>
<h2 id="_9"><a name="user-content-_9" href="#_9" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>配置规则</h2>
<p>一般情况下匹配某一规则由3个参数组成，第二个参数标识第一个参数类型,第三个参数表示是否取反，默认为<code>nil</code> 即 <code>false</code> 表示不取反</p>
<p>hostname：<code>["*",""]</code> = <code>["*","",false]</code></p>
<p>==&gt;表示匹配所有域名（使用字符串匹配，非正则，非常快）</p>
<p>hostname：<code>["*\\.game\\.com","jio"]</code> </p>
<p>==&gt;表示使用正则匹配host（<strong>ngx.re.find($host,参数1，参数2)</strong>）</p>
<p>hostname：<code>[["127.0.0.1","127.0.0.1:8080"],"table"]</code> </p>
<p>==&gt;表示匹配参数1列表中所有host</p>
<p>hostname：<code>[{"127.0.0.1":true,"127.0.0.1:5460":true},"list"]</code> </p>
<p>==&gt;表示匹配list中host为true的host</p>
<p>uri：<code>["/admin","in"]</code> </p>
<p>==&gt;表示匹配uri中包含/admin的所有uri都会被匹配（<strong>string.find($uri,参数1,1,true)</strong>）</p>
<p>ip：<code>[["127.0.0.1/32",""113.45.199.0/24""],"cidr"]</code> </p>
<p>==&gt;表示匹配的ip在这两组ip段/ip中</p>
<p>args：<code>["*","",["args_name","all"],false]</code> <br />
args：<code>["*","",["args_name","end"]]</code> = <code>["*","",["args_name","end"],false]</code><br />
args：<code>["*","",["args_name",1]]</code> </p>
<p>说明：第3个参数表示取args参数table的key名称，第3个参数<a href="http://openresty.org/cn/">2</a>表示取args[args_name]为table时，匹配任意(all)，匹配最后一个(end),匹配第几个(数字)，默认取第一个</p>
<p>==&gt;表示匹配的GET的args参数名为args_name,使用第4个参数模式进行匹配，匹配规则就是第一个和二个参数。其中第1、2参数支持前面描述的规则方式。</p>
<p><strong>table类型的匹配规则比较麻烦，暂时想着是这样处理，有好的想法可以告诉我</strong></p>
<h2 id="_10"><a name="user-content-_10" href="#_10" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>执行流程</h2>
<p><img alt="enter description here" src="///D://Rolan%E7%9B%AE%E5%BD%95/git/openstar/doc/Openstar.jpg" title="OpenStar.jpg" /></p>
<ul>
<li>init阶段</li>
</ul>
<p>a：首先加载本地的base.json配置文件，将相关配置读取到config_dict,host_dict,ip_dict中</p>
<ul>
<li>access阶段（自上到下的执行流程，规则列表也是自上到下按循序执行的）</li>
</ul>
<p>0：realIpFrom_Mod ==&gt; 获取用户真实IP（从HTTP头获取，如设置）</p>
<p>1：ip_Mod ==&gt; 请求ip的黑/白名单、log记录</p>
<p>2：host_method_Mod ==&gt; host和method过滤（白名单）</p>
<p>3：rewrite_Mod ==&gt; 跳转模块，set-cookie操作</p>
<p>4：host_Mod ==&gt; 对应host执行的规则过滤（uri,referer,useragent等）</p>
<pre><code>这里是产品中提供给独立用户使用的过滤规则。目前支持自定义规则组（任意参数，任意组合）
</code></pre>
<p>5：app_Mod ==&gt; 用户自定义应用层过滤</p>
<p>6：referer_Mod ==&gt; referer过滤（黑/白名单、log记录）</p>
<p>7：uri_Mod ==&gt; uri过滤（黑/白名单、log记录）</p>
<p>8：header_Mod ==&gt; header过滤（黑名单）</p>
<p>9：useragent_Mod ==&gt; useragent过滤（黑/白名单、log记录）</p>
<p>10：cookie_Mod ==&gt; cookie过滤（黑/白名单、log记录）</p>
<p>11：args_Mod ==&gt; args参数过滤[实际是query_string]（黑/白名单、log记录）</p>
<p>12：post_Mod ==&gt; post参数过滤[实际是整个post内容]（黑/白名单、log记录）</p>
<p>13：network_Mod ==&gt; 应用层网络频率限制（频率黑名单）</p>
<ul>
<li>body阶段</li>
</ul>
<p>14：replace_Mod ==&gt; 内容替换规则（动态进行内容替换，性能消耗较高慎用，可以的话用app_Mod中rehtml、refile这2个自定义action）</p>
<h2 id="step-0-realipfrom_mod"><a name="user-content-step-0-realipfrom_mod" href="#step-0-realipfrom_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step0">STEP 0 : realIpFrom_Mod </span></h2>
<ul>
<li>说明：<br />
<code>{"101.200.122.200:5460": {"ips": ["*",""],"realipset": "x-for-f"}}</code></li>
</ul>
<p>通过上面的例子，表示域名id.game.com,从ips来的直连ip，用户真实ip在x-for-f中，ips是支持二阶匹配，可以参考例子进行设置，ips为*时，表示不区分直连ip了。</p>
<h2 id="step-1ip_modlog"><a name="user-content-step-1ip_modlog" href="#step-1ip_modlog" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step1">STEP 1：ip_Mod（黑/白名单、log记录）</span></h2>
<ul>
<li>说明：<br />
<code>{"ip":"111.206.199.61","action":"allow"}</code><br />
<code>{"ip":"www.game.com-111.206.199.1","action":"deny"}</code></li>
</ul>
<p>上面的例子，表示ip为111.206.199.61（从http头获取，如设置）白名单<br />
 action可以取值[allow、deny]，deny表示黑名单；第二个就表示对应host的ip黑/白名单，其他host不受影响。</p>
<h2 id="step-2host95method95mod"><a name="user-content-step-2host95method95mod" href="#step-2host95method95mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step2">STEP 2：host_method_Mod（白名单）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"on","method":[["GET","POST"],"table"],"hostname":[["id.game.com","127.0.0.1"],"table"]}</code></li>
</ul>
<p>上面的例子表示，规则开启，host为id.game.com、127.0.0.1允许的method是GET和POST<br />
  state：表示规则是否开启<br />
  method：表示允许的method，参数2标识参数1是字符串、list、正则<br />
  hostname：表示匹配的host，规则同上</p>
<blockquote>
<p><strong><code>"method": [["GET","POST"],"table"]</code>==&gt; 表示匹配的method是GET和POST</strong></p>
<p><strong><code>"method": ["^(get|post)$","jio"]</code> ==&gt; 表示匹配method是正则匹配</strong></p>
<p><strong><code>"hostname": ["*",""]</code> ==&gt;表示匹配任意host（字符串匹配，非正则，非常快）</strong></p>
<p><strong>后面的很多规则都是使用该方式匹配的</strong></p>
</blockquote>
<h2 id="step-3-rewrite_mod"><a name="user-content-step-3-rewrite_mod" href="#step-3-rewrite_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step3">STEP 3: rewrite_Mod（跳转模块）</span></h2>
<ul>
<li>说明：<br />
<pre><code>    {
        &quot;state&quot;: &quot;on&quot;,
        &quot;action&quot;: [&quot;set-cookie&quot;],
    &quot;set_cookie&quot;:[&quot;asjldisdafpopliu8909jk34jk&quot;,&quot;token_name&quot;],
        &quot;hostname&quot;: [&quot;101.200.122.200&quot;,&quot;&quot;],
        &quot;uri&quot;: [&quot;^/rewrite$&quot;,&quot;jio&quot;]
    }
</code></pre><br />
上面的例子表示规则启用，host为101.200.122.200,且url匹配成功的进行302/307跳转，同时设置一个无状态cookie，名称是token。action中第二个参数是用户ip+和改参数进行md5计算的。请自行使用一个无意义字符串。防止攻击者猜测出生成算法。</li>
</ul>
<h2 id="step-4host_mod"><a name="user-content-step-4host_mod" href="#step-4host_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step4">STEP 4：host_Mod </span></h2>
<ul>
<li>说明：<br />
 该模块是匹配对应host进行规则匹配，在conf_json/host_json/目录下，本地的基于host的匹配规则<br />
 支持host.state状态支持[on log off],log即表示原匹配被拦截将失效，off表示不做任何规则的过滤</li>
</ul>
<h2 id="step-5app_modaction"><a name="user-content-step-5app_modaction" href="#step-5app_modaction" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step5">STEP 5：app_Mod（自定义action）</span></h2>
<ul>
<li>说明：<br />
<code>{
    "state":"on",
    "action":["deny"],
    "hostname":["127.0.0.1",""],
    "uri":["^/([\w]{4}\.html|deny1\.do|你好\.html)$","jio"]
}</code></li>
</ul>
<p>上面的例子表示规则启用，host为127.0.0.1，且url符合正则匹配的，拒绝访问</p>
<p>state：规则是否启用<br />
  action：执行动作</p>
<p>1：deny ==&gt; 拒绝访问</p>
<p>2：allow ==&gt; 允许访问</p>
<p>3：log ==&gt; 仅记录日志</p>
<p>4：rehtml ==&gt; 表示返回自定义字符串</p>
<p>5：refile ==&gt; 表示返回自定义文件（文件内容返回）</p>
<p>6：relua ==&gt; 表示返回lua执行脚本（使用dofile操作）</p>
<p>7：relua_str ==&gt; 表示返回lua代码执行</p>
<p>hostname：匹配的host</p>
<p>uri：匹配的uri</p>
<blockquote>
<p><strong>hostname 和 uri 使用上面描述过的匹配规则，参数2标记、参数1内容</strong></p>
<p><strong>详细参见项目中的demo规则，多实验、多测试就知道效果了</strong></p>
<p><strong>各种高级功能基本就靠这个模块来实现了，需要你发挥想象</strong></p>
</blockquote>
<h2 id="step-6referer_mod"><a name="user-content-step-6referer_mod" href="#step-6referer_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step6">STEP 6：referer_Mod（白名单）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"on","uri":["\\.(gif|jpg|png|jpeg|bmp|ico)$","jio"],"hostname":["127.0.0.1",""],"referer":["*",""],"action":"allow"}</code></li>
</ul>
<p>上面的例子表示，host为127.0.0.1，uri配置的正则成功，referer正则匹配成功就放行<strong>【这里把一些图片等静态资源可以放到这里，因为使用OpenStar，不需要将access_by_lua_file 专门放到nginx的不同的location动态节点去，这样后续的匹配规则就不对这些静态资源进行匹配了，减少总体的匹配次数，提高效率】</strong>，action表示执行的动作，<code>allow</code>表示规则匹配成功后，跳出后续所有规则（一般对静态资源图片），referer匹配失败就拒绝访问（白名单），防盗链为主；规则的取反可以设置防护站外的CSRF</p>
<p>state：表示规则是否开启<br />
  uri：表示匹配的uri<br />
  hostname：匹配host<br />
  referer：匹配referer<br />
  action：匹配动作</p>
<blockquote>
<p>referer的匹配是白名单，注意一下即可<br />
这些匹配都是基于上面说过的二阶匹配法</p>
</blockquote>
<h2 id="step-7uri_mod"><a name="user-content-step-7uri_mod" href="#step-7uri_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step7">STEP 7：uri_Mod（黑、白名单）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"on","hostname":["\*",""],"uri":["\\.(css|js|flv|swf|zip|txt)$","jio"],"action":"allow"}</code></li>
</ul>
<p>上面的例子表示，规则启用，任意host，uri正则匹配成功后放行，不进行后续规则匹配（该场景同图片等静态资源一样进行放行，减少后续的匹配）<br />
  state：表示规则是否开启<br />
  hostname：表示匹配的host<br />
  uri：表示匹配uri<br />
  action：可取值[allow、deny、log]，表示匹配成功后的执行动作</p>
<blockquote>
<p>一般情况下，过滤完静态资源后，剩下的都是拒绝一下uri的访问如.svn等一些敏感目录或文件</p>
</blockquote>
<h2 id="step-8header_mod"><a name="user-content-step-8header_mod" href="#step-8header_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step8">STEP 8：header_Mod（黑名单）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"on","uri":["\*",""],"hostname":["\*",""],"header":["Acunetix_Aspect","\*",""]}</code></li>
</ul>
<p>上面的例子表示，规则启用，匹配任意host，任意uri，header中Acunetix_Aspect内容的匹配（本次匹配任意内容）这个匹配是一些扫描器过滤，该规则是wvs扫描器的特征<br />
 state：规则是否启用<br />
 uri：匹配uri<br />
 hostname：匹配host<br />
 header：匹配header头</p>
<h2 id="step-9useragent_mod"><a name="user-content-step-9useragent_mod" href="#step-9useragent_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step9">STEP 9：useragent_Mod （黑名单）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"off","action":"deny","useragent":["HTTrack|harvest|audit|dirbuster|pangolin|nmap|sqln|-scan|hydra|Parser|libwww|BBBike|sqlmap|w3af|owasp|Nikto|fimap|havij|PycURL|zmeu|BabyKrokodil|netsparker|httperf|bench","jio"],"hostname":[["127.0.0.1:8080","127.0.0.1"],"table"]}</code></li>
</ul>
<p>上面的例子表示，规则关闭，匹配host为127.0.0.1 和 127.0.0.1:8080 ，useragent正则匹配，匹配成功则拒绝访问，一般host设置为：<code>"hostname":["*",""]</code>表示所有（字符串匹配，非常快）<br />
  state：规则是否启用<br />
  hostname：匹配host<br />
  useragent：匹配agent<br />
  action：匹配动作</p>
<h2 id="step-10cookie_mod"><a name="user-content-step-10cookie_mod" href="#step-10cookie_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step10">STEP 10：cookie_Mod（黑名单）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"on","cookie":["\\.\\./","jio"],"hostname":["*",""],"action":"deny"}</code></li>
</ul>
<p>上面的例子表示，规则启用，匹配任意host，cookies匹配正则，匹配成功则执行拒绝访问操作<br />
  state：表示规则是否启用<br />
  cookie：表示匹配cookie<br />
  hostname：表示匹配host<br />
  action：可选参数[deny、allow] 表示执行动作</p>
<blockquote>
<p>action后续可以能增加其他action，所以预留在这，否则黑名单根本不需要action参数</p>
</blockquote>
<h2 id="step-11args_mod"><a name="user-content-step-11args_mod" href="#step-11args_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step11">STEP 11：args_Mod（黑名单）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"on","hostname":["*",""],"args_data":["\\:\\$","jio"],"action":"deny"}</code></li>
</ul>
<p>上面例子表示，规则启用，匹配任意host，query_string参数组匹配正则，成功则执行拒绝访问动作<br />
 state：表示规则是否启用<br />
 hostname：表示匹配host<br />
 query_string：表示匹配args参数组<br />
 action：表示匹配成功拒绝访问</p>
<h2 id="step-12post_mod"><a name="user-content-step-12post_mod" href="#step-12post_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step12">STEP 12：post_Mod（黑名单）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"on","hostname":["*",""],"posts_data":["\\$\\{","jio"],"action":"deny"}</code></li>
</ul>
<p>上面的例子表示，规则启用，匹配任意host,post_str参数组匹配正则，成功则拒绝访问<br />
  state：表示是否启用规则<br />
  hostname：匹配host<br />
  post_str：匹配post参数组<br />
  action：匹配成功后拒绝访问</p>
<h2 id="step-13network_mod"><a name="user-content-step-13network_mod" href="#step-13network_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step13">STEP 13：network_Mod（频率黑名单）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"on","network":{"maxReqs":20,"pTime":10,"blackTime":600},"hostname":["id.game.com",""],"uri":["^/2.html$","jio"]}</code></li>
</ul>
<p>上面的例子表示，规则启用，host为id.game.com,url匹配正则，匹配成功则进行访问频率限制，在10秒内访问次数超过20次，请求的IP到IP黑名单中10分钟（60秒*10）<br />
  state：表示是否启用规则<br />
  hostname：表示匹配host<br />
  uri：表示匹配uri<br />
  network：maxReqs ==&gt; 请求次数；pTime ==&gt; 单位时间；blacktime ==&gt; ip黑名单时长</p>
<blockquote>
<p>一般情况下，cc攻击的点一个网站只有为数不多的地方是容易被攻击的点，所以设计时，考虑增加通过url细化匹配。</p>
</blockquote>
<h2 id="step-14replace_mod"><a name="user-content-step-14replace_mod" href="#step-14replace_mod" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a><span id = "step14">STEP 14：replace_Mod（内容替换）</span></h2>
<ul>
<li>说明：<br />
<code>{"state":"on","uri":["^/$","jio"],"hostname":["passport.game.com",""],"replace_list":[["联合","","联合FUCK"],["登录","","登录POSS"],["lzcaptcha\\?key='\\s\*\\+ key","jio","lzcaptcha?keY='+key+'&amp;keytoken=@token@'"]]}</code></li>
</ul>
<p>上面的例子表示，规则启用，host为passport.game.com,url是正则匹配，匹配成功则进行返回内容替换<br />
  1：将&rdquo;联合&rdquo;替换为&rdquo;联合FUCK&rdquo;；<br />
  2：将&rdquo;登录&rdquo;替换为&rdquo;登录POSS&rdquo;；<br />
  3：通过正则进行匹配（<code>ngx.re.gsub</code>）其中@token@表示动态替换为服务器生成的一个唯一随机字符串<br />
  state：表示是否启用规则<br />
  hostname：表示匹配的host<br />
  uri：表示匹配的uri<br />
  replace_list：表示替换列表，参数1 ==&gt; 被替换内容；参数2 ==&gt; 匹配模式（正则、字符串）如例子中前2个替换列表就是字符串匹配，使用&rdquo;&ldquo;即可，不能没有；参数3 ==&gt; 被替换的内容</p>
<h1 id="api"><a name="user-content-api" href="#api" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>API相关</h1>
<p>参考doc目录下的api.md说明</p>
<h1 id="_11"><a name="user-content-_11" href="#_11" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>样例</h1>
<ul>
<li>参见doc下，demo.md说明</li>
</ul>
<h1 id="_12"><a name="user-content-_12" href="#_12" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>性能评测</h1>
<p><strong>操作系统信息</strong><br />
OpenStar测试服务器：</p>
<p><pre><code> 微软虚机，内网测试

 uname -a :
 Linux dpicsvr01 4.2.0-30-generic #36-Ubuntu SMP Fri Feb 26 00:58:07 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux

 内存：
 cat /proc/meminfo | grep MemTotal
 MemTotal:       14360276 kB// 14GB

 CPU型号：cat /proc/cpuinfo | grep 'model name' |uniq
 Intel(R) Xeon(R) CPU E5-2660 0 @ 2.20GHz

 CPU核数：cat /proc/cpuinfo | grep &quot;cpu cores&quot; | uniq
 4

 CPU个数：cat /proc/cpuinfo | grep &quot;physical id&quot; | uniq | wc -l
 1 
 ab：
 ab -c 1000 -n 100000 &quot;http://10.0.0.4/test/a?a=b&amp;c=d&quot;
</code></pre><br />
测试结果：<br />
<img alt="enter description here" src="///D://Rolan%E7%9B%AE%E5%BD%95/git/openstar/doc/test.png" title="test.png" /><br />
 通过图片可以看到，关闭所有规则，做了2组测试，取最高的<code>8542</code>；</p>
<p>启用规则（排除app，network，replace），测试结果<code>8388</code>，性能下降<code>1.81%</code>；</p>
<p>启用规则（排除replace，app中未启用relua这个高消耗点），测试结果<code>7959</code>，性能下降<code>6.83%</code>；</p>
<p>启用规则（排除useragent，ab工具默认被拦截了，第二个测试就不完全了。）测试结果<code>7116</code>，性能下降<code>16%</code>；</p>
<p>总的来说，启用规则后，性能损失可以接受，根据自身的业务进行调整，还可以有所优化。</p>
<h1 id="_13"><a name="user-content-_13" href="#_13" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>变更历史</h1>
<h2 id="17-next"><a name="user-content-17-next" href="#17-next" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>1.7 更新二阶匹配规则支持取反，动作取消next等</h2>
<p>原二阶规则：[&ldquo;baidu&rdquo;,&rdquo;in&rdquo;],支持取反后：[&ldquo;baidu&rdquo;,&rdquo;in&rdquo;,true];最后的默认是nil也就是false,不取反的意思，所以规则基本可以之间复用，动作为next的需要修改一下即可</p>
<h2 id="16-count_dictdb-2key"><a name="user-content-16-count_dictdb-2key" href="#16-count_dictdb-2key" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>1.6 更新计数count_dict到DB 2,key也进行分开，优化规则缓存</h2>
<p>规则进行了缓存，大幅提高性能，json文件保存进行了美化等......</p>
<h2 id="15-masterslave"><a name="user-content-15-masterslave" href="#15-masterslave" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>1.5 应一些朋友强烈要求增加Master/Slave模式</h2>
<p>主：定时将内存中的配置推送到redis, 从：定时从redis拉取数据到内存后，并保存到文件</p>
<h2 id="14"><a name="user-content-14" href="#14" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>1.4 更新命名相关，以多规则匹配</h2>
<p>原来url改成uri，args改成query_string，修改的比较多，还有增加app_Mod实现多规则匹配，连接符支持OR</p>
<h2 id="13-set-cookie"><a name="user-content-13-set-cookie" href="#13-set-cookie" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>1.3 更新跳转功能，可配置进行set-cookie操作</h2>
<p>可以配置某一个或者多个url使用跳转set-cookie操作。cookie是无状态的。</p>
<h2 id="12-csrf"><a name="user-content-12-csrf" href="#12-csrf" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>1.2 更新支持拦截外部的csrf</h2>
<p>在referer_Mod处，增加action，<code>allow</code>表示允许且后续的规则不用在匹配（一般是静态资源如图片/js/css等），<code>next</code>表示白名单匹配成功后，会继续后面的规则匹配（这里就用于拦截外部的CSRF）增加<code>next</code>是因为原来代码中，若配置了防护站外的CSRF，后续的规则会bypass,所以增加的，这样就不会出现一些绕过问题。<br />
<strong>后续的action理论上都支持该语法</strong></p>
<h2 id="11-app_modallowip"><a name="user-content-11-app_modallowip" href="#11-app_modallowip" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>1.1 增加app_Mod,丰富allow动作（ip）</h2>
<p>网站的某个目录进行IP白名单的访问控制（后台、phpmyadmin等）</p>
<h2 id="09-10"><a name="user-content-09-10" href="#09-10" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>0.9 - 1.0 修改了大量全局函数</h2>
<p>在学习完<a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/index.html">OpenResty最佳实践</a>后，代码太不专业，修改了大量全局变量、函数</p>
<h2 id="08"><a name="user-content-08" href="#08" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>0.8 优化一下算法</h2>
<p>原来args是遍历每个参数在连接起来，感觉性能有时有点瓶颈，就使用新api取出url中的所有参数，经过测试效果要比原来好很多。</p>
<h2 id="07"><a name="user-content-07" href="#07" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>0.7 增加集群版本</h2>
<p>当时大约有2-4台OpenStar服务器用于安全防护，通过脚本进行统一管理的，没有进行真正的统一管理，所以抽空的时候把redis用上。</p>
<h2 id="06-api"><a name="user-content-06-api" href="#06-api" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>0.6 增加API相关操作</h2>
<p>因为是个蹩脚的程序员（没办法，搞安全的现在都被逼的写代码了；感谢春哥，我在写的过程中非常的快乐，所以就把项目叫做OpenStar[开心]，请勿见笑了）、前端界面我迟迟没有想好，所以先把一下操作的API封装了，也满足当时公司脚本化需求。</p>
<h2 id="04-05"><a name="user-content-04-05" href="#04-05" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>0.4-0.5 增加配置文件操作</h2>
<p>刚开始都是写在lua代码中，随着功能增加，决定通过配置文件进行操作，所有就使用json方式进行定义配置文件。</p>
<h2 id="03-waf"><a name="user-content-03-waf" href="#03-waf" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>0.3 增加waf防护模块</h2>
<p>随着cc防护成功后，我陆续增加了waf相关的功能，规则参考了<a href="http://www.modsecurity.org/">modsecurity</a>、<a href="https://github.com/loveshell/ngx_lua_waf">loveshell</a>防护模块、以及互联网搜集的一些过滤点</p>
<h2 id="02-cc"><a name="user-content-02-cc" href="#02-cc" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>0.2 CC防护应用层版</h2>
<p>通过网络层+应用层的防护后，我后续增加了应用层的安全防护，如应用层set cookie、url跳转、js跳转等这样应用层的防护模块</p>
<h2 id="01-cc"><a name="user-content-01-cc" href="#01-cc" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>0.1 CC防护版</h2>
<p>当时是为了解决公司的CC攻击，由于一些硬件抗D设备在新的网络环境下（有CDN网络下）无法获取用户真实IP头，我才动手将第一个版本完成，当时功能就是有通过自定义HTTP头获取用户真实ip进行访问频率的限制。（OpenStar可以根据某个url进行频率限制，不仅仅是整个网站的[排除静态文件，如设置了referer_Mod 或者 url_Mod 中资源的allow操作]）</p>
<h1 id="_14"><a name="user-content-_14" href="#_14" class="headeranchor-link" aria-hidden="true"><span class="headeranchor"></span></a>关于</h1>
<ul>
<li>关于该项目前面其实已经说了不少，从无到有基本都说了，强调下，感谢春哥，<a href="https://github.com/loveshell/ngx_lua_waf">loveshell</a>！！！</li>
<li>关于我：从事安全、架构相关工作。</li>
<li>Copyright and License<br />
GPL（GNU General Public License）<br />
Copyright (C) 2011-2016, by zj </li>
</ul></article></body></html>